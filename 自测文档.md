# 自测文档

> 项目：简化版用户权限管理系统
> 作者：XXX  日期：2025-06-17

---

## 目录

1. [环境准备](#1-环境准备)
2. [启动步骤](#2-启动步骤)
3. [功能验证用例](#3-功能验证用例)
4. [失败与回滚场景](#4-失败与回滚场景)
5. [MQ 与日志校验](#5-mq-与日志校验)
6. [并发注册压测（可选）](#6-并发注册压测可选)
7. [清理与关闭](#7-清理与关闭)

---

## 1. 环境准备

| 组件           | 版本  | 备注                                                  |
| -------------- | ----- | ----------------------------------------------------- |
| JDK            | 17    | `java -version` 验证                                |
| Maven          | 3.8+  | `mvn -v` 验证                                       |
| Docker         | 24+   | 安装[https://docs.docker.com/](https://docs.docker.com/) |
| Docker-compose | 2.20+ | 用于一键启动外部依赖                                  |
| Git            | 任意  | clone 代码                                            |

### 1.1 克隆代码

```bash
git clone https://github.com/Ho-da-ka/AuthDemo.git
cd AuthDemo/test
```

### 1.2 启动基础组件

```bash
docker compose -f docker-compose.yml up -d
# 包含 mysql(4) / nacos / rabbitmq / seata-server
```
> 默认端口
>
> * Nacos: 8848  * RabbitMQ: 5672 / 15672
> * Seata-Server: 8091 * MySQL: 3306 / 3307 / 3308

---

## 2. 启动步骤

```bash
# 根目录一次性打包
mvn clean package -DskipTests

# 终端 1：logging-service（必须先起，确保能消费日志）
cd logging-service && java -jar target/*.jar

# 终端 2：permission-service
cd permission-service && java -jar target/*.jar

# 终端 3：user-service
cd user-service && java -jar target/*.jar
```

> 三个服务启动成功后，Nacos UI (http://localhost:8848/nacos) 能看到 `user-service / permission-service / logging-service` 均为 **UP** 状态。

---

## 3. 功能验证用例

| # | 用例                 | 请求示例                                                                                                                                                               | 预期结果                                 | 数据库校验                                                                             |
| - | -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- | -------------------------------------------------------------------------------------- |
| 1 | 注册                 | `curl -X POST http://localhost:8082/users/register -H "Content-Type:application/json" -d '{"username":"alice","password":"123456","email":"a@b.com","phone":"188"}'` | HTTP `200`，返回 `token`、`userId` | `SELECT * FROM users_* WHERE username='alice';` 结果=1 行；`user_roles` 有对应记录 |
| 2 | 登录                 | `curl -X POST http://localhost:8082/users/login -d '{"username":"alice","password":"123456"}' -H "Content-Type:application/json"`                                    | 返回 JWT                                 | —                                                                                     |
| 3 | 普通用户查自己       | `curl -H "Authorization:Bearer $TOKEN" http://localhost:8082/users`                                                                                                  | 只含自己                                 | —                                                                                     |
| 4 | 超管查全量           | `TOKEN_SUPER` 同上                                                                                                                                                   | 返回全部 >0                              | —                                                                                     |
| 5 | 超管升级用户为管理员 | `curl -X PUT http://localhost:8081/Permission/upgrade/$USERID`                                                                                                       | 204                                      | `user_roles.role_id=3`                                                               |
| 6 | 管理员修改普通用户   | ...                                                                                                                                                                    | 200                                      | users 表更新                                                                           |

> 将上表内容全部跑一遍，截图响应 JSON 与 SQL 结果，粘贴到文档末尾 **附录：验证截图**。

---

## 4. 失败与回滚场景

### 4.1 故意触发权限服务异常

```bash
# 模拟 PermissionService 抛异常（可暂时停掉 permission-service）
docker stop permission-service
curl -X POST http://localhost:8082/users/register -d '{"username":"err","password":"1","email":"e@e.com","phone":"100"}' -H "Content-Type:application/json"
```

* 预期：HTTP 500，返回 `"try to proceed invocation error"`
* 数据库：`users_*` 与 `user_roles` 均 **没有** `username='err'`（Seata AT 回滚成功）

### 4.2 普通用户越权访问

```bash
curl -H "Authorization:Bearer $USER_TOKEN" http://localhost:8082/users/$OTHERID
```

* 预期：HTTP 403 + `"权限不足"`

---

## 5. MQ 与日志校验

```bash
# RabbitMQ 管理端查看队列深度
open http://localhost:15672 (guest / guest)

# 日志表检查最新 5 行
docker exec -it mysql-logging mysql -uroot -p284100 -e "SELECT log_id,action,detail FROM operation_logs ORDER BY log_id DESC LIMIT 5;"
```

* 预期：注册、登录、查询等操作均有对应日志；RabbitMQ 队列无积压。

---

## 6. 并发注册压测（可选）

```bash
ab -n 100 -c 20 -p register.json -T "application/json" http://localhost:8082/users/register
# register.json 内容为随机用户名，可用脚本生成
```

* 预期：全部 200；分片库中新增 100 条用户、MQ 日志 100 条，无重复键异常。

---

## 7. 清理与关闭

```bash
# 关闭 Spring Boot
CTRL+C

# 停止并删除容器
docker compose -f infra/docker-compose.yml down -v
```

---

## 附录：验证截图

> 此处粘贴关键接口响应与数据库查询截图，便于评审老师快速确认。

```text
<在此插入图片或终端输出>
```

```

> **备注**  
> * 文档中的 IP / 端口、数据库密码需与你 `application.yaml` 保持一致。  
> * 如果使用 Postman，可将测试用例导出为 `postman_collection.json` 随文档提交。
```
